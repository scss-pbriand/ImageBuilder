@page "/imagetype/{Id:guid}"
@using Domain.Images
@inject NavigationManager Navigation

<PageTitle>Image Type Editor</PageTitle>

<MudContainer Class="py-6">
    <MudStack Spacing="4">
        <MudStack Row="true" AlignItems="AlignItems.Center" JustifyContent="SpaceBetween">
            <MudText Typo="Typo.h4">@(_imageType?.Name ?? "Image Type")</MudText>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       StartIcon="@Icons.Material.Filled.ArrowBack"
                       OnClick="NavigateBack">
                Back
            </MudButton>
        </MudStack>

        <MudPaper Class="pa-4">
            <MudStack Spacing="2">
                <MudText Typo="Typo.subtitle1">Categories</MudText>

                <MudDataGrid @ref="_dataGrid" Items="@_categories" ReadOnly="false" EditMode="@DataGridEditMode.Cell" ExpandSingleRow="true">
                    <Columns>
                        <HierarchyColumn T="ImageCategory" />
                        <PropertyColumn Property="x => x.Name" Title="Name" />
                        <PropertyColumn Property="x => x.Description" Title="Description" />
                        <PropertyColumn Property="x => x.ProbabilityWeight" Title="Probability" />
                        <PropertyColumn Property="x => x.InsertionOrder" Title="Order" />
                    </Columns>
                    <ChildRowContent>
                        <MudCard>
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h6">@context.Item.Name</MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <CategoryAssetsGrid Category="@context.Item"
                                                    OnEditAsset="EditAsset"
                                                    OnDeleteAsset="DeleteAsset"
                                                    OnAddAsset="AddAsset" />
                            </MudCardContent>
                        </MudCard>
                    </ChildRowContent>
                    <PagerContent>
                        <MudDataGridPager T="ImageCategory" />
                    </PagerContent>
                </MudDataGrid>

                
            </MudStack>
        </MudPaper>
    </MudStack>
</MudContainer>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private MudDataGrid<ImageCategory> _dataGrid = null!;
    private ImageType? _imageType;
    private IEnumerable<ImageCategory> _categories = new List<ImageCategory>();

    protected override Task OnParametersSetAsync()
    {
        LoadImageType();
        return Task.CompletedTask;
    }

    private void LoadImageType()
    {
        _imageType = new ImageType
        {
            Id = Id,
            Name = "Sample Image Type",
            Description = "Sample description",
            Categories = new List<ImageCategory>
            {
                new ImageCategory
                {
                    Id = Guid.NewGuid(),
                    Name = "Backgrounds",
                    Description = "Background elements",
                    ProbabilityWeight = 0.5,
                    ImageAssets = new List<ImageAsset>
                    {
                        new ImageAsset
                        {
                            Id = Guid.NewGuid(),
                            ImageDataId = Guid.NewGuid(),
                            Name = "Sunset",
                        },
                        new ImageAsset
                        {
                            Id = Guid.NewGuid(),
                            ImageDataId = Guid.NewGuid(),
                            Name = "Mountains",
                        },
                        new ImageAsset
                        {
                            Id = Guid.NewGuid(),
                            ImageDataId = Guid.NewGuid(),
                            Name = "Forest",
                        }
                    }
                },
                new ImageCategory
                {
                    Id = Guid.NewGuid(),
                    Name = "Characters",
                    Description = "Character overlays",
                    ProbabilityWeight = 0.3,
                    ImageAssets = new List<ImageAsset>()
                },
                new ImageCategory
                {
                    Id = Guid.NewGuid(),
                    Name = "Accessories",
                    Description = "Accessory additions",
                    ProbabilityWeight = 0.2,
                    ImageAssets = new List<ImageAsset>()
                }
            }
        };

        _categories = [];
        if (_imageType.Categories is not null)
        {
            _categories = _imageType.Categories;
        }
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/manage-image-types");
    }

    private void EditCategory(ImageCategory category)
    {
        // TODO: Implement category editing logic.
    }

    private void DeleteCategory(ImageCategory category)
    {
        // TODO: Implement category deletion logic.
    }

    private void EditAsset(ImageAsset asset)
    {
        // TODO: Implement asset editing logic.
    }

    private void DeleteAsset(ImageAsset asset)
    {
        // TODO: Implement asset deletion logic.
    }

    private void AddAsset(ImageCategory category)
    {
        // TODO: Implement new asset creation logic.
    }
}
